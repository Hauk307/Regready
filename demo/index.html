<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dead Zone Hunt - Wyoming Hunting Regulations</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #e0e0e0;
            min-height: 100vh;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('topo-pattern.jpg');
            background-size: cover;
            background-position: center;
            z-index: -1;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        header { text-align: center; padding: 20px 0; }
        
        .logo-img {
            max-width: 100%;
            width: 100%;
            margin: 0 auto 10px;
            display: block;
        }
        
        h1 {
            font-size: 2.5em;
            color: #4ade80;
            text-shadow: 0 0 30px rgba(74, 222, 128, 0.5);
            display: none;
        }
        
        .subtitle { color: #888; margin-top: 5px; }
        
        .card {
            background: rgba(30, 30, 30, 0.95);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        /* Species selector - 3 columns */
        .species-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .species-btn {
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
            border: 2px solid #333;
            border-radius: 12px;
            padding: 15px 10px;
            color: #ccc;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .species-btn .species-emoji { font-size: 28px; line-height: 1; display: none; }
        
        .species-btn .species-icon {
            width: 36px;
            height: 36px;
            filter: invert(1) brightness(0.85);
        }
        
        .species-btn.active .species-icon {
            filter: invert(48%) sepia(79%) saturate(500%) hue-rotate(100deg) brightness(1.1);
        }
        
        .species-btn:hover {
            border-color: #4ade80;
            transform: translateY(-2px);
        }
        
        .species-btn.active {
            border-color: #4ade80;
            background: linear-gradient(145deg, #1a3a1a, #0a2a0a);
            color: #4ade80;
        }
        
        label { display: block; color: #888; margin-bottom: 8px; font-size: 14px; }
        
        select {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #1a1a1a;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }
        
        select:focus { outline: none; border-color: #4ade80; }
        
        .area-count {
            text-align: center;
            color: #666;
            font-size: 13px;
            margin-top: 10px;
        }
        
        .official-badge {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            color: #4ade80;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .disclaimer {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #f59e0b;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            text-align: center;
            margin-top: 10px;
        }
        
        /* Results */
        .results {
            background: rgba(30, 30, 30, 0.95);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #333;
            display: none;
        }
        
        .results.visible { display: block; }
        
        .results h2 {
            color: #4ade80;
            margin-bottom: 5px;
            font-size: 1.3em;
        }
        
        .area-status {
            color: #f87171;
            font-size: 1.1em;
            font-weight: 600;
            padding: 20px 0;
        }
        
        /* License type card */
        .license-card {
            background: #1a1a1a;
            border-radius: 10px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        
        .license-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
        }
        
        .license-header.general { background: rgba(34, 197, 94, 0.15); border-left: 4px solid #22c55e; }
        .license-header.limited { background: rgba(245, 158, 11, 0.15); border-left: 4px solid #f59e0b; }
        
        .license-name { font-weight: 700; font-size: 1.05em; }
        .license-name.general { color: #22c55e; }
        .license-name.limited { color: #f59e0b; }
        
        .license-quota {
            font-size: 0.85em;
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .license-quota.general { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .license-quota.limited { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        
        /* Segments */
        .segments { padding: 0 15px 15px; }
        
        .segment {
            padding: 10px 0;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .segment:last-child { border-bottom: none; }
        
        .segment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .weapon-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .weapon-badge.archery { background: #7c3aed; color: #fff; }
        .weapon-badge.rifle { background: #dc2626; color: #fff; }
        .weapon-badge.muzzleloader { background: #0891b2; color: #fff; }
        
        .segment-dates {
            color: #fff;
            font-weight: 600;
            font-size: 14px;
        }
        
        .segment-limitation {
            color: #ccc;
            font-size: 13px;
            margin-top: 4px;
        }
        
        .segment-restriction {
            color: #f59e0b;
            font-size: 12px;
            margin-top: 3px;
            font-style: italic;
        }
        
        .segment-validin {
            color: #4ade80;
            font-size: 12px;
            margin-top: 3px;
        }
        
        /* Non-resident region badge */
        .nr-region {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(96, 165, 250, 0.1);
            border: 1px solid rgba(96, 165, 250, 0.3);
            color: #60a5fa;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 12px;
        }
        
        .nr-region-letter {
            font-size: 1.3em;
            font-weight: 800;
        }
        
        .nr-region-quota { font-weight: 600; }
        
        /* CWD testing badge */
        .cwd-badge {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
        }
        
        /* Map */
        .map-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(145deg, #2a4a2a, #1a3a1a);
            border: 2px solid #4ade80;
            border-radius: 10px;
            color: #4ade80;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.2s;
        }
        
        .map-btn:hover {
            background: linear-gradient(145deg, #3a5a3a, #2a4a2a);
            transform: translateY(-2px);
        }
        
        .map-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            padding: 20px;
            overflow: auto;
        }
        
        .map-modal.visible { display: flex; flex-direction: column; }
        
        .map-close {
            position: fixed;
            top: 20px; right: 20px;
            background: #333;
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001;
        }
        
        .map-modal img { max-width: 100%; margin: auto; border-radius: 8px; }
        
        /* Shooting Hours Widget */
        .sun-widget {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 20px;
            border: 1px solid #1e3a5f;
        }
        
        .sun-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .sun-title {
            color: #f59e0b;
            font-weight: 700;
            font-size: 13px;
        }
        
        .sun-location {
            font-size: 11px;
            color: #64748b;
        }
        
        .sun-location.gps { color: #4ade80; }
        
        .sun-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .sun-time-compact {
            text-align: center;
            flex: 1;
        }
        
        .sun-time-compact .label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sun-time-compact .time {
            font-size: 1.1em;
            font-weight: 800;
            margin: 2px 0;
        }
        
        .sun-time-compact .emoji { font-size: 14px; }
        
        .sun-time-compact.rise .time { color: #fbbf24; }
        .sun-time-compact.set .time { color: #ef4444; }
        
        .sun-divider {
            width: 1px;
            height: 40px;
            background: #334155;
            margin: 0 8px;
        }
        
        .legal-bar {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.25);
            border-radius: 6px;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .legal-label {
            color: #4ade80;
            font-size: 11px;
            font-weight: 600;
        }
        
        .legal-times {
            color: #fff;
            font-weight: 700;
            font-size: 13px;
        }
        
        .moon-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(148, 163, 184, 0.08);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 8px;
        }
        
        .moon-phase {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .moon-emoji { font-size: 22px; }
        
        .moon-name {
            color: #cbd5e1;
            font-size: 12px;
            font-weight: 600;
        }
        
        .moon-illumination {
            color: #64748b;
            font-size: 11px;
        }
        
        .sun-date-row {
            display: flex;
            justify-content: center;
            margin-top: 8px;
        }
        
        .sun-date-input {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #fff;
            padding: 4px 8px;
            font-size: 12px;
            text-align: center;
        }
        
        /* Search */
        .search-wrap {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 14px 14px 42px;
            border-radius: 12px;
            border: 2px solid #333;
            background: #1a1a1a;
            color: #fff;
            font-size: 16px;
        }
        
        .search-input:focus { outline: none; border-color: #4ade80; }
        
        .search-input::placeholder { color: #555; }
        
        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #555;
            font-size: 18px;
        }
        
        .search-results {
            display: none;
            margin-bottom: 20px;
        }
        
        .search-results.visible { display: block; }
        
        .search-count {
            color: #888;
            font-size: 13px;
            margin-bottom: 10px;
        }
        
        .rule-card {
            background: rgba(30, 30, 30, 0.95);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #333;
            border-left: 3px solid #60a5fa;
        }
        
        .rule-category {
            font-size: 11px;
            color: #60a5fa;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .rule-title {
            color: #fff;
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 8px;
        }
        
        .rule-content {
            color: #bbb;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .rule-content mark {
            background: rgba(74, 222, 128, 0.3);
            color: #fff;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .search-clear {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            font-size: 18px;
            cursor: pointer;
            display: none;
        }
        
        .search-clear.visible { display: block; }
        
        footer {
            text-align: center;
            padding: 30px;
            color: #555;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="regready-logo.png" alt="Dead Zone" class="logo-img">
            <h1>Dead Zone</h1>
            <p class="subtitle"></p>
        </header>
        
        <div class="sun-widget" id="sun-widget">
            <div class="sun-top-row">
                <span class="sun-title">üåÑ Shooting Hours</span>
                <span class="sun-location" id="sun-location">üìç Locating...</span>
            </div>
            <div id="sun-display">
                <div class="sun-main">
                    <div class="sun-time-compact rise">
                        <div class="label">Sunrise</div>
                        <div class="time" id="sun-rise">--:--</div>
                        <div class="emoji">üåÖ</div>
                    </div>
                    <div class="sun-divider"></div>
                    <div class="sun-time-compact set">
                        <div class="label">Sunset</div>
                        <div class="time" id="sun-set">--:--</div>
                        <div class="emoji">üåá</div>
                    </div>
                </div>
                <div class="legal-bar">
                    <span class="legal-label">üéØ Legal Shooting</span>
                    <span class="legal-times" id="sun-legal">--:-- ‚Äî --:--</span>
                </div>
                <div class="moon-bar" id="moon-bar">
                    <div class="moon-phase">
                        <span class="moon-emoji" id="moon-emoji">üåë</span>
                        <span class="moon-name" id="moon-name">--</span>
                    </div>
                    <span class="moon-illumination" id="moon-illum">--%</span>
                </div>
                <div class="sun-date-row">
                    <input type="date" class="sun-date-input" id="sun-date">
                </div>
            </div>
        </div>
        
        <div class="search-wrap">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="search-input" placeholder="Search rules & regulations...">
            <button class="search-clear" id="search-clear">‚úï</button>
        </div>
        
        <div class="search-results" id="search-results"></div>
        
        <div class="card">
            <div class="species-grid">
                <button class="species-btn active" data-species="elk">
                    <img class="species-icon" src="elk-icon.svg" alt="Elk">
                    Elk
                </button>
                <button class="species-btn" data-species="deer">
                    <img class="species-icon" src="deer-icon.svg" alt="Deer">
                    Deer
                </button>
                <button class="species-btn" data-species="antelope">
                    <img class="species-icon" src="antelope-icon.svg" alt="Antelope">
                    Antelope
                </button>
            </div>
        </div>
        
        <div class="card">
            <div class="official-badge">‚úÖ Official WGFD 2025 data</div>
            <label for="area-select">Select Hunt Area</label>
            <select id="area-select"><option value="">-- Choose an Area --</option></select>
            <div class="area-count" id="area-count"></div>
            <button class="map-btn" id="view-map-btn">üó∫Ô∏è View Hunt Area Map</button>
            <div class="disclaimer">‚ö†Ô∏è Unofficial app. Not affiliated with WGFD. Always verify with official regulations.</div>
        </div>
        
        <div class="results" id="results"></div>
        
        <footer>
            <p>Dead Zone Demo ‚Ä¢ 2025 WY G&F Regulations</p>
            <p style="margin-top: 5px; opacity: 0.7;">Built in Wyoming ü§†</p>
        </footer>
    </div>
    
    <div class="map-modal" id="map-modal">
        <button class="map-close" id="map-close">‚úï Close</button>
        <img id="map-img" src="" alt="Hunt Area Map">
    </div>
    
    <script src="data.js"></script>
    <script src="area_coords.js"></script>
    <script src="sun_calc.js"></script>
    <script>
        let currentSpecies = 'elk';
        
        const speciesMaps = {
            elk: 'maps/elk_map.png',
            deer: 'maps/deer_map.png',
            antelope: 'maps/antelope_map.png'
        };
        
        const speciesData = {
            elk: typeof elkData !== 'undefined' ? elkData : {},
            deer: typeof deerData !== 'undefined' ? deerData : {},
            antelope: typeof antelopeData !== 'undefined' ? antelopeData : {}
        };
        
        function populateAreas() {
            const select = document.getElementById('area-select');
            const data = speciesData[currentSpecies];
            const areas = Object.keys(data).map(Number).sort((a, b) => a - b);
            
            select.innerHTML = '<option value="">-- Choose an Area --</option>';
            areas.forEach(area => {
                const d = data[area];
                const opt = document.createElement('option');
                opt.value = area;
                // Show area number and if it's closed
                if (d.status === 'Closed') {
                    opt.textContent = `Area ${area} ‚Äî CLOSED`;
                    opt.disabled = true;
                } else {
                    const types = Object.keys(d.licenses).join(', ');
                    const nrTag = d.nrRegion ? ` [Region ${d.nrRegion.letter}]` : '';
                    const cwdTag = d.cwdTesting ? ' ‚ö†Ô∏è' : '';
                    opt.textContent = `Area ${area}${nrTag}${cwdTag} (${types})`;
                }
                select.appendChild(opt);
            });
            
            const activeAreas = areas.filter(a => data[a].status !== 'Closed');
            document.getElementById('area-count').textContent = `${activeAreas.length} hunt areas`;
            document.getElementById('results').classList.remove('visible');
        }
        
        function showResults(area) {
            const data = speciesData[currentSpecies][area];
            if (!data) return;
            
            const resultsDiv = document.getElementById('results');
            const speciesName = currentSpecies.charAt(0).toUpperCase() + currentSpecies.slice(1);
            
            let html = `<h2>${speciesName} Area ${area}</h2>`;
            
            if (data.status === 'Closed') {
                html += `<div class="area-status">üö´ This area is CLOSED for the 2025 season</div>`;
                resultsDiv.innerHTML = html;
                resultsDiv.classList.add('visible');
                return;
            }
            
            // Non-resident region info (deer only)
            if (data.nrRegion) {
                html += `
                    <div class="nr-region">
                        <div>üè∑Ô∏è Non-Resident Region <span class="nr-region-letter">${data.nrRegion.letter}</span></div>
                        <div class="nr-region-quota">${data.nrRegion.quota.toLocaleString()} NR tags</div>
                    </div>
                `;
            }
            
            // CWD testing badge
            if (data.cwdTesting) {
                html += `
                    <div class="cwd-badge">‚ö†Ô∏è Mandatory CWD Testing Area ‚Äî ${data.cwdTesting}</div>
                `;
            }
            
            if (!data.licenses) return;
            
            const licenses = Object.entries(data.licenses);
            
            licenses.forEach(([typeName, license]) => {
                const isGeneral = license.category === 'general';
                const catClass = isGeneral ? 'general' : 'limited';
                
                // Quota display
                let quotaText = '';
                if (isGeneral) {
                    quotaText = 'Over the Counter';
                } else if (license.quota === null || license.quota === 'Unlimited') {
                    quotaText = 'Unlimited';
                } else {
                    quotaText = `${license.quota} tags`;
                }
                
                html += `
                    <div class="license-card">
                        <div class="license-header ${catClass}">
                            <span class="license-name ${catClass}">${typeName}</span>
                            <span class="license-quota ${catClass}">${quotaText}</span>
                        </div>
                        <div class="segments">
                `;
                
                license.segments.forEach(seg => {
                    const weaponClass = seg.weapon || 'rifle';
                    
                    html += `
                        <div class="segment">
                            <div class="segment-header">
                                <span class="weapon-badge ${weaponClass}">${seg.weapon}</span>
                                <span class="segment-dates">${seg.dates}</span>
                            </div>
                            <div class="segment-limitation">${seg.limitation}</div>
                    `;
                    
                    if (seg.restriction) {
                        html += `<div class="segment-restriction">üìç ${seg.restriction}</div>`;
                    }
                    if (seg.validIn) {
                        html += `<div class="segment-validin">üîó ${seg.validIn}</div>`;
                    }
                    
                    html += `</div>`;
                });
                
                html += `</div></div>`;
            });
            
            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('visible');
            
            // Update sun widget if area selected (fallback coords)
            if (typeof getAreaCoords === 'function') {
                const coords = getAreaCoords(currentSpecies, parseInt(area));
                if (coords && !sunState.gpsActive) {
                    sunState.lat = coords.lat;
                    sunState.lon = coords.lon;
                    document.getElementById('sun-location').textContent = `üìç ${currentSpecies.charAt(0).toUpperCase() + currentSpecies.slice(1)} Area ${area}`;
                    refreshSunWidget();
                }
            }
        }
        
        // Event listeners
        document.querySelectorAll('.species-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.species-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentSpecies = btn.dataset.species;
                populateAreas();
            });
        });
        
        document.getElementById('area-select').addEventListener('change', (e) => {
            if (e.target.value) showResults(e.target.value);
        });
        
        document.getElementById('view-map-btn').addEventListener('click', () => {
            document.getElementById('map-img').src = speciesMaps[currentSpecies];
            document.getElementById('map-modal').classList.add('visible');
        });
        
        document.getElementById('map-close').addEventListener('click', () => {
            document.getElementById('map-modal').classList.remove('visible');
        });
        
        // Search functionality
        const searchInput = document.getElementById('search-input');
        const searchResultsDiv = document.getElementById('search-results');
        const searchClear = document.getElementById('search-clear');
        const rules = typeof rulesData !== 'undefined' ? rulesData : [];
        
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            searchClear.classList.toggle('visible', query.length > 0);
            
            if (query.length < 2) {
                searchResultsDiv.classList.remove('visible');
                return;
            }
            
            searchTimeout = setTimeout(() => performSearch(query), 200);
        });
        
        searchClear.addEventListener('click', () => {
            searchInput.value = '';
            searchClear.classList.remove('visible');
            searchResultsDiv.classList.remove('visible');
        });
        
        function performSearch(query) {
            const terms = query.toLowerCase().split(/\s+/);
            
            const scored = rules.map(rule => {
                let score = 0;
                const titleLow = (rule.title || '').toLowerCase();
                const contentLow = (rule.content || '').toLowerCase();
                const keywords = (rule.keywords || []).map(k => k.toLowerCase());
                
                for (const term of terms) {
                    if (titleLow.includes(term)) score += 10;
                    if (keywords.some(k => k.includes(term))) score += 5;
                    if (contentLow.includes(term)) score += 1;
                }
                
                return { rule, score };
            }).filter(r => r.score > 0)
              .sort((a, b) => b.score - a.score)
              .slice(0, 20);
            
            if (scored.length === 0) {
                searchResultsDiv.innerHTML = '<div class="search-count">No results found</div>';
                searchResultsDiv.classList.add('visible');
                return;
            }
            
            let html = `<div class="search-count">${scored.length} result${scored.length > 1 ? 's' : ''}</div>`;
            
            scored.forEach(({ rule }) => {
                let content = rule.content || '';
                
                // Highlight matching terms
                for (const term of terms) {
                    const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    content = content.replace(regex, '<mark>$1</mark>');
                }
                
                html += `
                    <div class="rule-card">
                        <div class="rule-category">${rule.category}</div>
                        <div class="rule-title">${rule.title}</div>
                        <div class="rule-content">${content}</div>
                    </div>
                `;
            });
            
            searchResultsDiv.innerHTML = html;
            searchResultsDiv.classList.add('visible');
        }
        
        // Shooting Hours Widget - GPS with fallback
        const sunState = {
            lat: 43.0,   // Default: center of Wyoming
            lon: -107.5,
            gpsActive: false
        };
        
        function initSunWidget() {
            const dateInput = document.getElementById('sun-date');
            const today = new Date();
            dateInput.value = today.toISOString().split('T')[0];
            dateInput.addEventListener('change', refreshSunWidget);
            
            // Try GPS
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        sunState.lat = pos.coords.latitude;
                        sunState.lon = pos.coords.longitude;
                        sunState.gpsActive = true;
                        document.getElementById('sun-location').textContent = 'üìç GPS Location';
                        document.getElementById('sun-location').classList.add('gps');
                        refreshSunWidget();
                        
                        // Keep updating GPS
                        navigator.geolocation.watchPosition((p) => {
                            sunState.lat = p.coords.latitude;
                            sunState.lon = p.coords.longitude;
                            refreshSunWidget();
                        }, null, { enableHighAccuracy: false, maximumAge: 300000 });
                    },
                    () => {
                        // GPS denied/unavailable - use default
                        document.getElementById('sun-location').textContent = 'üìç Wyoming (select area for exact)';
                        refreshSunWidget();
                    },
                    { enableHighAccuracy: false, timeout: 5000 }
                );
            } else {
                document.getElementById('sun-location').textContent = 'üìç Wyoming';
                refreshSunWidget();
            }
        }
        
        function getMoonPhase(date) {
            // Calculate moon phase using Conway's method
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            let r = year % 100;
            r %= 19;
            if (r > 9) r -= 19;
            r = ((r * 11) % 30) + month + day;
            if (month < 3) r += 2;
            r -= ((year < 2000) ? 4 : 8.3);
            r = Math.floor(r + 0.5) % 30;
            if (r < 0) r += 30;
            
            // r is now 0-29, representing days into the lunar cycle
            const phase = r / 29.53;
            const illumination = Math.round((1 - Math.cos(phase * 2 * Math.PI)) / 2 * 100);
            
            let name, emoji;
            if (r === 0) { name = "New Moon"; emoji = "üåë"; }
            else if (r < 4) { name = "Waxing Crescent"; emoji = "üåí"; }
            else if (r < 8) { name = "First Quarter"; emoji = "üåì"; }
            else if (r < 11) { name = "Waxing Gibbous"; emoji = "üåî"; }
            else if (r < 16) { name = "Full Moon"; emoji = "üåï"; }
            else if (r < 19) { name = "Waning Gibbous"; emoji = "üåñ"; }
            else if (r < 23) { name = "Last Quarter"; emoji = "üåó"; }
            else if (r < 27) { name = "Waning Crescent"; emoji = "üåò"; }
            else { name = "New Moon"; emoji = "üåë"; }
            
            return { name, emoji, illumination, dayOfCycle: r };
        }
        
        function refreshSunWidget() {
            if (typeof calculateSunTimes !== 'function') return;
            
            const dateInput = document.getElementById('sun-date');
            const date = new Date(dateInput.value + 'T12:00:00');
            const times = calculateSunTimes(sunState.lat, sunState.lon, date);
            
            document.getElementById('sun-rise').textContent = times.sunrise;
            document.getElementById('sun-set').textContent = times.sunset;
            document.getElementById('sun-legal').textContent = `${times.legalStart} ‚Äî ${times.legalEnd}`;
            
            // Moon phase
            const moon = getMoonPhase(date);
            document.getElementById('moon-emoji').textContent = moon.emoji;
            document.getElementById('moon-name').textContent = moon.name;
            document.getElementById('moon-illum').textContent = `${moon.illumination}% illuminated`;
        }
        
        initSunWidget();
        
        // Initialize
        populateAreas();
    </script>
</body>
</html>
